name: Regenerate SDK from Swagger

on:
  repository_dispatch:
    types: [swagger-updated]
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PAT }}

      - name: Fetch latest swagger.yaml
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          # Use GitHub API to bypass CDN caching
          gh api repos/buildio/antimony/contents/swagger/v1/swagger.yaml \
            --jq '.content' | base64 -d > swagger.yaml
          echo "Fetched swagger.yaml ($(wc -l < swagger.yaml) lines)"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Clean generated files
        run: |
          # Remove generated models to force full regeneration
          rm -rf src/build-client/models src/build-client/api
          rm -f src/build-client.cr src/openapi_client.cr
          echo "Cleaned generated files"

      - name: Generate SDK
        run: |
          npx @openapitools/openapi-generator-cli generate \
            -i swagger.yaml \
            -g crystal \
            -o .

      - name: Determine next version
        id: version
        run: |
          LATEST=$(git tag -l 'v*' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1)
          LATEST="${LATEST:-v0.0.0}"
          MAJOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST" | sed 's/v//' | cut -d. -f3)
          NEXT_VER="${MAJOR}.${MINOR}.$((PATCH + 1))"
          echo "bare=${NEXT_VER}" >> $GITHUB_OUTPUT
          echo "tag=v${NEXT_VER}" >> $GITHUB_OUTPUT
          echo "Next SDK version: v${NEXT_VER}"

      - name: Patch shard.yml with correct name and version
        run: |
          VER="${{ steps.version.outputs.bare }}"
          sed -i "s/^name: .*/name: build-client/" shard.yml
          sed -i "s/^version: .*/version: ${VER}/" shard.yml
          echo "Patched shard.yml:"
          head -5 shard.yml

      - name: Commit, tag, and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Regenerate SDK from latest swagger.yaml"
          fi
          git tag "${{ steps.version.outputs.tag }}"
          git push origin main --tags

      - name: Dispatch to CLI
        if: success()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.RELEASE_PAT }}
          repository: buildio/cli
          event-type: sdk-updated
          client-payload: '{"sdk": "crystal"}'
